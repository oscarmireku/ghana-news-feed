{"version":3,"sources":["../../../../news/src/lib/db.ts"],"sourcesContent":["import { createClient } from '@libsql/client';\r\n\r\nconst url = process.env.TURSO_DATABASE_URL || 'file:news.db';\r\nconst authToken = process.env.TURSO_AUTH_TOKEN;\r\n\r\nexport const db = createClient({\r\n  url,\r\n  authToken,\r\n});\r\n\r\n// Initialize database (Async wrapper needed or call this explicitly if needed, \r\n// using top-level await if environment supports it, but simpler to invoke lazily or just ensure it exists.)\r\n// For simplicity in Next.js Serverless, we can attempt to init on load or just cache the promise.\r\n// Actually, pure SQL CREATE TABLE IF NOT EXISTS is cheap.\r\n\r\nasync function initDb() {\r\n  await db.execute(`\r\n    CREATE TABLE IF NOT EXISTS articles (\r\n      id TEXT PRIMARY KEY,\r\n      source TEXT NOT NULL,\r\n      title TEXT NOT NULL,\r\n      link TEXT UNIQUE NOT NULL,\r\n      image TEXT,\r\n      time TEXT NOT NULL,\r\n      section TEXT NOT NULL,\r\n      timestamp INTEGER NOT NULL,\r\n      created_at INTEGER NOT NULL,\r\n      content TEXT\r\n    )\r\n  `);\r\n}\r\n\r\n// We can just run this. in a serverless env it might run multiple times but it's safe.\r\n// Ideally we'd await this before other ops.\r\ninitDb().catch(console.error);\r\n\r\n\r\nexport interface Article {\r\n  id: string;\r\n  source: string;\r\n  title: string;\r\n  link: string;\r\n  image: string | null;\r\n  time: string;\r\n  section: string;\r\n  timestamp: number;\r\n  created_at?: number;\r\n  content?: string;\r\n}\r\n\r\nexport async function insertArticles(articles: Article[]): Promise<number> {\r\n  if (articles.length === 0) return 0;\r\n\r\n  let count = 0;\r\n\r\n  // We process individually to ensure one bad egg (duplicate ID) doesn't spoil the bunch\r\n  for (const article of articles) {\r\n    try {\r\n      await db.execute({\r\n        sql: `\r\n          INSERT INTO articles (id, source, title, link, image, time, section, timestamp, created_at, content)\r\n          VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\r\n          ON CONFLICT(link) DO UPDATE SET\r\n            time = excluded.time,\r\n            timestamp = excluded.timestamp,\r\n            image = excluded.image,\r\n            title = excluded.title,\r\n            content = CASE WHEN excluded.content IS NOT NULL THEN excluded.content ELSE articles.content END\r\n        `,\r\n        args: [\r\n          article.id,\r\n          article.source,\r\n          article.title,\r\n          article.link,\r\n          article.image,\r\n          article.time,\r\n          article.section,\r\n          article.timestamp,\r\n          Date.now(),\r\n          article.content || null\r\n        ]\r\n      });\r\n      count++;\r\n    } catch (err: any) {\r\n      if (err.code === 'SQLITE_CONSTRAINT') {\r\n        console.warn(`[DB] Skipped duplicate/conflict for ${article.title} (${article.id}):`, err.message);\r\n      } else {\r\n        console.error(`[DB] Error inserting ${article.title}:`, err);\r\n      }\r\n    }\r\n  }\r\n\r\n  return count;\r\n}\r\n\r\nexport async function getAllArticles(limit: number = 500, includeContent: boolean = false): Promise<Article[]> {\r\n  const rs = await db.execute({\r\n    sql: `\r\n      SELECT id, source, title, link, image, time, section, timestamp${includeContent ? ', content' : ''}\r\n      FROM articles\r\n      ORDER BY timestamp DESC\r\n      LIMIT ?\r\n    `,\r\n    args: [limit]\r\n  });\r\n\r\n  // rs.rows is correct\r\n  return rs.rows as unknown as Article[];\r\n}\r\n\r\nexport async function getArticlesSince(\r\n  sinceTimestamp: number,\r\n  limit: number = 500,\r\n  includeContent: boolean = false\r\n): Promise<Article[]> {\r\n  const rs = await db.execute({\r\n    sql: `\r\n      SELECT id, source, title, link, image, time, section, timestamp${includeContent ? ', content' : ''}\r\n      FROM articles\r\n      WHERE timestamp > ?\r\n      ORDER BY timestamp DESC\r\n      LIMIT ?\r\n    `,\r\n    args: [sinceTimestamp, limit]\r\n  });\r\n\r\n  return rs.rows as unknown as Article[];\r\n}\r\n\r\nexport async function getArticleCount(): Promise<number> {\r\n  const rs = await db.execute('SELECT COUNT(*) as count FROM articles');\r\n  return Number(rs.rows[0].count);\r\n}\r\n\r\nexport async function getAllLinks(): Promise<Set<string>> {\r\n  const rs = await db.execute('SELECT link FROM articles');\r\n  const links = new Set<string>();\r\n  for (const row of rs.rows) {\r\n    if (typeof row.link === 'string') {\r\n      links.add(row.link);\r\n    }\r\n  }\r\n  return links;\r\n}\r\n\r\nexport async function getLatestTimestampsBySource(): Promise<Map<string, number>> {\r\n  const rs = await db.execute('SELECT source, MAX(timestamp) as max_time FROM articles GROUP BY source');\r\n  const map = new Map<string, number>();\r\n  for (const row of rs.rows) {\r\n    if (typeof row.source === 'string' && typeof row.max_time === 'number') {\r\n      map.set(row.source, row.max_time);\r\n    }\r\n  }\r\n  return map;\r\n}\r\n\r\n\r\nexport async function deleteOldArticles(limit: number): Promise<number> {\r\n  // SQLite doesn't support DELETE ... LIMIT directly in all versions, \r\n  // but simpler: DELETE WHERE id NOT IN (SELECT id ... LIMIT ?)\r\n  const rs = await db.execute({\r\n    sql: `\r\n      DELETE FROM articles \r\n      WHERE id NOT IN (\r\n        SELECT id FROM articles \r\n        ORDER BY timestamp DESC \r\n        LIMIT ?\r\n      )\r\n    `,\r\n    args: [limit]\r\n  });\r\n  return rs.rowsAffected;\r\n}\r\n\r\nexport async function deleteInvalidArticles(): Promise<number> {\r\n  const unwantedTitlePatterns = [\r\n    'Home - News', 'Home - Business', 'Home - Sports', 'Home-Business',\r\n    'Business archive', 'News Archive', 'Sports Archive', 'Photo Archives',\r\n    'Archive', 'Category:', 'Section:', 'More News', 'More Stories',\r\n    'View All', 'Latest News', 'Top Stories', 'Click here', 'Read more',\r\n    'TWI News', 'News Videos', 'GhanaWeb TV', '| TV',\r\n    'Year In Review', 'Players Abroad', 'National Team(s)',\r\n    'Stock Exchange', 'Exchange Rate', '(GSE)'\r\n  ];\r\n\r\n  let count = 0;\r\n  try {\r\n    // REMOVED: Deletion of articles without images\r\n    // This was causing valid articles from feeds like ZionFelix, YFM Ghana to be deleted\r\n    // Only delete SVG images which are usually logos/icons, not article images\r\n    const badImageResult = await db.execute(`\r\n      DELETE FROM articles \r\n      WHERE image LIKE '%.svg%'\r\n         OR image LIKE '%.svg?%'\r\n    `);\r\n    count += badImageResult.rowsAffected;\r\n\r\n    // Construct OR conditions for titles\r\n    if (unwantedTitlePatterns.length > 0) {\r\n      const conditions = unwantedTitlePatterns.map(() => `title LIKE ?`).join(' OR ');\r\n      const args = unwantedTitlePatterns.map(p => `%${p}%`);\r\n\r\n      const badTitleResult = await db.execute({\r\n        sql: `DELETE FROM articles WHERE ${conditions}`,\r\n        args: args\r\n      });\r\n      count += badTitleResult.rowsAffected;\r\n    }\r\n\r\n  } catch (err) {\r\n    console.error('Error deleting invalid articles:', err);\r\n  }\r\n  return count;\r\n}\r\n"],"names":[],"mappings":"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"}