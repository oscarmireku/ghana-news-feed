{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 124, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/oscar/news/src/lib/db.ts"],"sourcesContent":["\r\nimport { sql } from '@vercel/postgres';\r\n\r\nexport interface Article {\r\n  id: string;\r\n  source: string;\r\n  title: string;\r\n  link: string;\r\n  image: string | null;\r\n  time: string;\r\n  section: string;\r\n  timestamp: number;\r\n  created_at?: number;\r\n  content?: string;\r\n}\r\n\r\n// Function to initialize the database (can be called from an endpoint or script)\r\nexport async function seedArticleTable() {\r\n  await sql`\r\n    CREATE TABLE IF NOT EXISTS articles (\r\n        id TEXT PRIMARY KEY,\r\n        source TEXT NOT NULL,\r\n        title TEXT NOT NULL,\r\n        link TEXT UNIQUE NOT NULL,\r\n        image TEXT,\r\n        time TEXT NOT NULL,\r\n        section TEXT NOT NULL,\r\n        timestamp BIGINT NOT NULL,\r\n        created_at BIGINT NOT NULL,\r\n        content TEXT\r\n    );\r\n    `;\r\n\r\n  // Indexes\r\n  await sql`CREATE INDEX IF NOT EXISTS idx_timestamp ON articles(timestamp DESC);`;\r\n  await sql`CREATE INDEX IF NOT EXISTS idx_link ON articles(link);`; // Unique constraint creates index implicitly but this is fine\r\n}\r\n\r\n\r\nexport async function insertArticle(article: Article): Promise<boolean> {\r\n  try {\r\n    const result = await sql`\r\n        INSERT INTO articles (id, source, title, link, image, time, section, timestamp, created_at, content)\r\n        VALUES (${article.id}, ${article.source}, ${article.title}, ${article.link}, ${article.image}, ${article.time}, ${article.section}, ${article.timestamp}, ${Date.now()}, ${article.content || null})\r\n        ON CONFLICT(link) DO UPDATE SET\r\n          time = EXCLUDED.time,\r\n          timestamp = EXCLUDED.timestamp,\r\n          image = EXCLUDED.image,\r\n          title = EXCLUDED.title,\r\n          content = CASE WHEN EXCLUDED.content IS NOT NULL THEN EXCLUDED.content ELSE articles.content END\r\n      `;\r\n    return (result.rowCount ?? 0) > 0;\r\n  } catch (error) {\r\n    console.error('Failed to insert article:', error);\r\n    return false;\r\n  }\r\n}\r\n\r\nexport async function insertArticles(articles: Article[]): Promise<number> {\r\n  let count = 0;\r\n  // Batch processing could be better, but sequential is safer for now with small batches\r\n  // TODO: Optimise to single INSERT statement for performance if needed\r\n  for (const article of articles) {\r\n    const success = await insertArticle(article);\r\n    if (success) count++;\r\n  }\r\n  return count;\r\n}\r\n\r\nexport async function getAllArticles(limit: number = 100): Promise<Article[]> {\r\n  const { rows } = await sql`\r\n    SELECT id, source, title, link, image, time, section, timestamp, content\r\n    FROM articles\r\n    WHERE image IS NOT NULL AND image != ''\r\n    ORDER BY timestamp DESC\r\n    LIMIT ${limit}\r\n  `;\r\n\r\n  // Convert BigInt to number for JS compatibility\r\n  return rows.map(row => ({\r\n    ...row,\r\n    timestamp: Number(row.timestamp),\r\n    created_at: Number(row.created_at)\r\n  })) as Article[];\r\n}\r\n\r\nexport async function getArticleByLink(link: string): Promise<Article | undefined> {\r\n  const { rows } = await sql`\r\n    SELECT id, source, title, link, image, time, section, timestamp, content\r\n    FROM articles\r\n    WHERE link = ${link}\r\n  `;\r\n\r\n  if (rows.length === 0) return undefined;\r\n\r\n  const row = rows[0];\r\n  return {\r\n    ...row,\r\n    timestamp: Number(row.timestamp),\r\n    created_at: Number(row.created_at)\r\n  } as Article;\r\n}\r\n\r\nexport async function getArticleCount(): Promise<number> {\r\n  const { rows } = await sql`SELECT COUNT(*) as count FROM articles`;\r\n  return Number(rows[0].count);\r\n}\r\n"],"names":[],"mappings":";;;;;;;;;;;;;;AACA;AAAA;;AAgBO,eAAe;IACpB,MAAM,kMAAG,CAAC;;;;;;;;;;;;;IAaR,CAAC;IAEH,UAAU;IACV,MAAM,kMAAG,CAAC,qEAAqE,CAAC;IAChF,MAAM,kMAAG,CAAC,sDAAsD,CAAC,EAAE,8DAA8D;AACnI;AAGO,eAAe,cAAc,OAAgB;IAClD,IAAI;QACF,MAAM,SAAS,MAAM,kMAAG,CAAC;;gBAEb,EAAE,QAAQ,EAAE,CAAC,EAAE,EAAE,QAAQ,MAAM,CAAC,EAAE,EAAE,QAAQ,KAAK,CAAC,EAAE,EAAE,QAAQ,IAAI,CAAC,EAAE,EAAE,QAAQ,KAAK,CAAC,EAAE,EAAE,QAAQ,IAAI,CAAC,EAAE,EAAE,QAAQ,OAAO,CAAC,EAAE,EAAE,QAAQ,SAAS,CAAC,EAAE,EAAE,KAAK,GAAG,GAAG,EAAE,EAAE,QAAQ,OAAO,IAAI,KAAK;;;;;;;MAOrM,CAAC;QACH,OAAO,CAAC,OAAO,QAAQ,IAAI,CAAC,IAAI;IAClC,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,6BAA6B;QAC3C,OAAO;IACT;AACF;AAEO,eAAe,eAAe,QAAmB;IACtD,IAAI,QAAQ;IACZ,uFAAuF;IACvF,sEAAsE;IACtE,KAAK,MAAM,WAAW,SAAU;QAC9B,MAAM,UAAU,MAAM,cAAc;QACpC,IAAI,SAAS;IACf;IACA,OAAO;AACT;AAEO,eAAe,eAAe,QAAgB,GAAG;IACtD,MAAM,EAAE,IAAI,EAAE,GAAG,MAAM,kMAAG,CAAC;;;;;UAKnB,EAAE,MAAM;EAChB,CAAC;IAED,gDAAgD;IAChD,OAAO,KAAK,GAAG,CAAC,CAAA,MAAO,CAAC;YACtB,GAAG,GAAG;YACN,WAAW,OAAO,IAAI,SAAS;YAC/B,YAAY,OAAO,IAAI,UAAU;QACnC,CAAC;AACH;AAEO,eAAe,iBAAiB,IAAY;IACjD,MAAM,EAAE,IAAI,EAAE,GAAG,MAAM,kMAAG,CAAC;;;iBAGZ,EAAE,KAAK;EACtB,CAAC;IAED,IAAI,KAAK,MAAM,KAAK,GAAG,OAAO;IAE9B,MAAM,MAAM,IAAI,CAAC,EAAE;IACnB,OAAO;QACL,GAAG,GAAG;QACN,WAAW,OAAO,IAAI,SAAS;QAC/B,YAAY,OAAO,IAAI,UAAU;IACnC;AACF;AAEO,eAAe;IACpB,MAAM,EAAE,IAAI,EAAE,GAAG,MAAM,kMAAG,CAAC,sCAAsC,CAAC;IAClE,OAAO,OAAO,IAAI,CAAC,EAAE,CAAC,KAAK;AAC7B"}},
    {"offset": {"line": 225, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/oscar/news/src/app/api/news/route.ts"],"sourcesContent":["\r\nimport { NextResponse } from 'next/server';\r\nimport { getAllArticles, getArticleCount } from '@/lib/db';\r\n\r\nexport const dynamic = 'force-dynamic';\r\n\r\nexport async function GET() {\r\n    try {\r\n        // Get all articles from database (limit to 200 most recent)\r\n        // These are async calls now with Vercel Postgres\r\n        const dbArticles = await getAllArticles(200);\r\n        const totalCount = await getArticleCount();\r\n\r\n        // format output\r\n        const storiesOutput = dbArticles.map(({ timestamp, created_at, ...story }) => story);\r\n\r\n        const data = {\r\n            generated_at: new Date().toISOString(),\r\n            count: storiesOutput.length,\r\n            total_in_database: totalCount,\r\n            stories: storiesOutput\r\n        };\r\n\r\n        return NextResponse.json(data);\r\n    } catch (e) {\r\n        console.error('Failed to fetch news:', e);\r\n        return NextResponse.json({ error: 'Failed to fetch news', details: String(e) }, { status: 500 });\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;;;AACA;AACA;;;AAEO,MAAM,UAAU;AAEhB,eAAe;IAClB,IAAI;QACA,4DAA4D;QAC5D,iDAAiD;QACjD,MAAM,aAAa,MAAM,IAAA,4IAAc,EAAC;QACxC,MAAM,aAAa,MAAM,IAAA,6IAAe;QAExC,gBAAgB;QAChB,MAAM,gBAAgB,WAAW,GAAG,CAAC,CAAC,EAAE,SAAS,EAAE,UAAU,EAAE,GAAG,OAAO,GAAK;QAE9E,MAAM,OAAO;YACT,cAAc,IAAI,OAAO,WAAW;YACpC,OAAO,cAAc,MAAM;YAC3B,mBAAmB;YACnB,SAAS;QACb;QAEA,OAAO,wJAAY,CAAC,IAAI,CAAC;IAC7B,EAAE,OAAO,GAAG;QACR,QAAQ,KAAK,CAAC,yBAAyB;QACvC,OAAO,wJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;YAAwB,SAAS,OAAO;QAAG,GAAG;YAAE,QAAQ;QAAI;IAClG;AACJ"}}]
}