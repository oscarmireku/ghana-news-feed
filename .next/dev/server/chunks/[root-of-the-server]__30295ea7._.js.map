{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 48, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/oscar/news/src/lib/db.ts"],"sourcesContent":["import { createClient } from '@libsql/client';\r\n\r\nconst url = process.env.TURSO_DATABASE_URL || 'file:news.db';\r\nconst authToken = process.env.TURSO_AUTH_TOKEN;\r\n\r\nexport const db = createClient({\r\n  url,\r\n  authToken,\r\n});\r\n\r\n// Initialize database (Async wrapper needed or call this explicitly if needed, \r\n// using top-level await if environment supports it, but simpler to invoke lazily or just ensure it exists.)\r\n// For simplicity in Next.js Serverless, we can attempt to init on load or just cache the promise.\r\n// Actually, pure SQL CREATE TABLE IF NOT EXISTS is cheap.\r\n\r\nasync function initDb() {\r\n  await db.execute(`\r\n    CREATE TABLE IF NOT EXISTS articles (\r\n      id TEXT PRIMARY KEY,\r\n      source TEXT NOT NULL,\r\n      title TEXT NOT NULL,\r\n      link TEXT UNIQUE NOT NULL,\r\n      image TEXT,\r\n      time TEXT NOT NULL,\r\n      section TEXT NOT NULL,\r\n      timestamp INTEGER NOT NULL,\r\n      created_at INTEGER NOT NULL,\r\n      content TEXT\r\n    )\r\n  `);\r\n}\r\n\r\n// We can just run this. in a serverless env it might run multiple times but it's safe.\r\n// Ideally we'd await this before other ops.\r\ninitDb().catch(console.error);\r\n\r\n\r\nexport interface Article {\r\n  id: string;\r\n  source: string;\r\n  title: string;\r\n  link: string;\r\n  image: string | null;\r\n  time: string;\r\n  section: string;\r\n  timestamp: number;\r\n  created_at?: number;\r\n  content?: string;\r\n}\r\n\r\nexport async function insertArticles(articles: Article[]): Promise<number> {\r\n  if (articles.length === 0) return 0;\r\n\r\n  let count = 0;\r\n  // LibSQL client doesn't support massive bulk inserts in one statement easily without constructing the string manually\r\n  // or using transactions nicely. \r\n  // We can use a transaction.\r\n\r\n  const tx = await db.transaction('write');\r\n  try {\r\n    for (const article of articles) {\r\n      await tx.execute({\r\n        sql: `\r\n          INSERT INTO articles (id, source, title, link, image, time, section, timestamp, created_at, content)\r\n          VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\r\n          ON CONFLICT(link) DO UPDATE SET\r\n            time = excluded.time,\r\n            timestamp = excluded.timestamp,\r\n            image = excluded.image,\r\n            title = excluded.title,\r\n            content = CASE WHEN excluded.content IS NOT NULL THEN excluded.content ELSE articles.content END\r\n        `,\r\n        args: [\r\n          article.id,\r\n          article.source,\r\n          article.title,\r\n          article.link,\r\n          article.image,\r\n          article.time,\r\n          article.section,\r\n          article.timestamp,\r\n          Date.now(),\r\n          article.content || null\r\n        ]\r\n      });\r\n      count++;\r\n    }\r\n    await tx.commit();\r\n    return count;\r\n\r\n  } catch (err) {\r\n    console.error('Error inserting articles:', err);\r\n    // Don't rollback explicitly, LibSQL client handles it or it just fails.\r\n    return 0;\r\n  }\r\n}\r\n\r\nexport async function getAllArticles(limit: number = 500): Promise<Article[]> {\r\n  const rs = await db.execute({\r\n    sql: `\r\n      SELECT id, source, title, link, image, time, section, timestamp, content\r\n      FROM articles\r\n      WHERE image IS NOT NULL AND image != ''\r\n      ORDER BY timestamp DESC\r\n      LIMIT ?\r\n    `,\r\n    args: [limit]\r\n  });\r\n\r\n  // rs.rows is correct\r\n  return rs.rows as unknown as Article[];\r\n}\r\n\r\nexport async function getArticleCount(): Promise<number> {\r\n  const rs = await db.execute('SELECT COUNT(*) as count FROM articles');\r\n  return Number(rs.rows[0].count);\r\n}\r\n\r\n\r\nexport async function deleteOldArticles(limit: number): Promise<number> {\r\n  // SQLite doesn't support DELETE ... LIMIT directly in all versions, \r\n  // but simpler: DELETE WHERE id NOT IN (SELECT id ... LIMIT ?)\r\n  const rs = await db.execute({\r\n    sql: `\r\n      DELETE FROM articles \r\n      WHERE id NOT IN (\r\n        SELECT id FROM articles \r\n        ORDER BY timestamp DESC \r\n        LIMIT ?\r\n      )\r\n    `,\r\n    args: [limit]\r\n  });\r\n  return rs.rowsAffected;\r\n}\r\n\r\nexport async function deleteInvalidArticles(): Promise<number> {\r\n  const unwantedTitlePatterns = [\r\n    'Home - News', 'Home - Business', 'Home - Sports', 'Home-Business',\r\n    'Business archive', 'News Archive', 'Sports Archive', 'Photo Archives',\r\n    'Archive', 'Category:', 'Section:', 'More News', 'More Stories',\r\n    'View All', 'Latest News', 'Top Stories'\r\n  ];\r\n\r\n  let count = 0;\r\n  try {\r\n    const badImageResult = await db.execute(`\r\n      DELETE FROM articles \r\n      WHERE image IS NULL \r\n         OR image = '' \r\n         OR image LIKE '%.svg%'\r\n         OR image LIKE '%.svg?%'\r\n    `);\r\n    count += badImageResult.rowsAffected;\r\n\r\n    // Construct OR conditions for titles\r\n    if (unwantedTitlePatterns.length > 0) {\r\n      const conditions = unwantedTitlePatterns.map(() => `title LIKE ?`).join(' OR ');\r\n      const args = unwantedTitlePatterns.map(p => `%${p}%`);\r\n\r\n      const badTitleResult = await db.execute({\r\n        sql: `DELETE FROM articles WHERE ${conditions}`,\r\n        args: args\r\n      });\r\n      count += badTitleResult.rowsAffected;\r\n    }\r\n\r\n  } catch (err) {\r\n    console.error('Error deleting invalid articles:', err);\r\n  }\r\n  return count;\r\n}\r\n"],"names":[],"mappings":";;;;;;;;;;;;;;AAAA;;;;;;AAEA,MAAM,MAAM,QAAQ,GAAG,CAAC,kBAAkB,IAAI;AAC9C,MAAM,YAAY,QAAQ,GAAG,CAAC,gBAAgB;AAEvC,MAAM,KAAK,IAAA,qNAAY,EAAC;IAC7B;IACA;AACF;AAEA,gFAAgF;AAChF,4GAA4G;AAC5G,kGAAkG;AAClG,0DAA0D;AAE1D,eAAe;IACb,MAAM,GAAG,OAAO,CAAC,CAAC;;;;;;;;;;;;;EAalB,CAAC;AACH;AAEA,uFAAuF;AACvF,4CAA4C;AAC5C,SAAS,KAAK,CAAC,QAAQ,KAAK;AAgBrB,eAAe,eAAe,QAAmB;IACtD,IAAI,SAAS,MAAM,KAAK,GAAG,OAAO;IAElC,IAAI,QAAQ;IACZ,sHAAsH;IACtH,iCAAiC;IACjC,4BAA4B;IAE5B,MAAM,KAAK,MAAM,GAAG,WAAW,CAAC;IAChC,IAAI;QACF,KAAK,MAAM,WAAW,SAAU;YAC9B,MAAM,GAAG,OAAO,CAAC;gBACf,KAAK,CAAC;;;;;;;;;QASN,CAAC;gBACD,MAAM;oBACJ,QAAQ,EAAE;oBACV,QAAQ,MAAM;oBACd,QAAQ,KAAK;oBACb,QAAQ,IAAI;oBACZ,QAAQ,KAAK;oBACb,QAAQ,IAAI;oBACZ,QAAQ,OAAO;oBACf,QAAQ,SAAS;oBACjB,KAAK,GAAG;oBACR,QAAQ,OAAO,IAAI;iBACpB;YACH;YACA;QACF;QACA,MAAM,GAAG,MAAM;QACf,OAAO;IAET,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,6BAA6B;QAC3C,wEAAwE;QACxE,OAAO;IACT;AACF;AAEO,eAAe,eAAe,QAAgB,GAAG;IACtD,MAAM,KAAK,MAAM,GAAG,OAAO,CAAC;QAC1B,KAAK,CAAC;;;;;;IAMN,CAAC;QACD,MAAM;YAAC;SAAM;IACf;IAEA,qBAAqB;IACrB,OAAO,GAAG,IAAI;AAChB;AAEO,eAAe;IACpB,MAAM,KAAK,MAAM,GAAG,OAAO,CAAC;IAC5B,OAAO,OAAO,GAAG,IAAI,CAAC,EAAE,CAAC,KAAK;AAChC;AAGO,eAAe,kBAAkB,KAAa;IACnD,qEAAqE;IACrE,8DAA8D;IAC9D,MAAM,KAAK,MAAM,GAAG,OAAO,CAAC;QAC1B,KAAK,CAAC;;;;;;;IAON,CAAC;QACD,MAAM;YAAC;SAAM;IACf;IACA,OAAO,GAAG,YAAY;AACxB;AAEO,eAAe;IACpB,MAAM,wBAAwB;QAC5B;QAAe;QAAmB;QAAiB;QACnD;QAAoB;QAAgB;QAAkB;QACtD;QAAW;QAAa;QAAY;QAAa;QACjD;QAAY;QAAe;KAC5B;IAED,IAAI,QAAQ;IACZ,IAAI;QACF,MAAM,iBAAiB,MAAM,GAAG,OAAO,CAAC,CAAC;;;;;;IAMzC,CAAC;QACD,SAAS,eAAe,YAAY;QAEpC,qCAAqC;QACrC,IAAI,sBAAsB,MAAM,GAAG,GAAG;YACpC,MAAM,aAAa,sBAAsB,GAAG,CAAC,IAAM,CAAC,YAAY,CAAC,EAAE,IAAI,CAAC;YACxE,MAAM,OAAO,sBAAsB,GAAG,CAAC,CAAA,IAAK,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC;YAEpD,MAAM,iBAAiB,MAAM,GAAG,OAAO,CAAC;gBACtC,KAAK,CAAC,2BAA2B,EAAE,YAAY;gBAC/C,MAAM;YACR;YACA,SAAS,eAAe,YAAY;QACtC;IAEF,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,oCAAoC;IACpD;IACA,OAAO;AACT"}},
    {"offset": {"line": 229, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/oscar/news/src/app/api/news/route.ts"],"sourcesContent":["\r\nimport { NextResponse } from 'next/server';\r\nimport { getAllArticles, getArticleCount } from '@/lib/db';\r\n\r\nexport const dynamic = 'force-dynamic';\r\nexport const revalidate = 0; // Always fresh from DB\r\n\r\nexport async function GET(request: Request) {\r\n    const { searchParams } = new URL(request.url);\r\n    const limitParam = searchParams.get('limit');\r\n    const limit = limitParam ? parseInt(limitParam) : 500;\r\n\r\n    try {\r\n        const [stories, total] = await Promise.all([\r\n            getAllArticles(limit),\r\n            getArticleCount()\r\n        ]);\r\n\r\n        return NextResponse.json({\r\n            stories,\r\n            count: stories.length,\r\n            total_in_database: total,\r\n        });\r\n    } catch (e) {\r\n        console.error('Error fetching news:', e);\r\n        return NextResponse.json({ error: 'Failed to fetch news' }, { status: 500 });\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;;;;;AACA;AACA;;;;;;;AAEO,MAAM,UAAU;AAChB,MAAM,aAAa,GAAG,uBAAuB;AAE7C,eAAe,IAAI,OAAgB;IACtC,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,QAAQ,GAAG;IAC5C,MAAM,aAAa,aAAa,GAAG,CAAC;IACpC,MAAM,QAAQ,aAAa,SAAS,cAAc;IAElD,IAAI;QACA,MAAM,CAAC,SAAS,MAAM,GAAG,MAAM,QAAQ,GAAG,CAAC;YACvC,IAAA,4IAAc,EAAC;YACf,IAAA,6IAAe;SAClB;QAED,OAAO,wJAAY,CAAC,IAAI,CAAC;YACrB;YACA,OAAO,QAAQ,MAAM;YACrB,mBAAmB;QACvB;IACJ,EAAE,OAAO,GAAG;QACR,QAAQ,KAAK,CAAC,wBAAwB;QACtC,OAAO,wJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAuB,GAAG;YAAE,QAAQ;QAAI;IAC9E;AACJ"}}]
}